<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>VIVO ESSENTIAL - Meu Calend√°rio</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="css/style.css" />
    <style>
      body {
        font-family: 'Inter', sans-serif;
      }
      .sidebar-link.active {
        background-color: #6d28d9;
        color: white;
      }
      .sidebar-link:not(.active):hover {
        background-color: #5b21b6;
      }
      .evento-card {
        background-color: rgba(55, 65, 81, 0.7); /* slate-700 com opacidade (gray-700) */
        border-left: 4px solid #8b5cf6; /* purple-500 */
        padding: 1rem;
        margin-bottom: 1rem;
        border-radius: 0.5rem; /* rounded-lg */
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
      }
      .evento-card h3 {
        color: #c4b5fd; /* purple-300 */
      }
      .form-input {
        background-color: #374151; /* gray-700 */
        border: 1px solid #4b5563; /* gray-600 */
        color: white;
        border-radius: 0.375rem; /* rounded-md */
        padding: 0.75rem 1rem; /* py-3 px-4 */
        width: 100%;
        transition: border-color 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
      }
      .form-input:focus {
        outline: none;
        border-color: #8b5cf6; /* purple-500 */
        box-shadow: 0 0 0 3px rgba(167, 139, 250, 0.4); /* purple-300 com opacidade para o anel */
      }
      .form-label {
        display: block;
        margin-bottom: 0.5rem; /* mb-2 */
        font-size: 0.875rem; /* text-sm */
        font-weight: 500; /* font-medium */
        color: #d1d5db; /* gray-300 */
      }
      .form-section {
        background-color: rgba(30, 41, 59, 0.8); /* slate-800 com opacidade */
        border: 1px solid rgba(79, 70, 229, 0.5); /* purple-600 com opacidade */
        border-radius: 0.75rem; /* rounded-xl */
        padding: 1.5rem; /* p-6 */
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
      }
    </style>
  </head>
  <body class="bg-slate-900 text-slate-200 selection:bg-purple-500 selection:text-white">
    <div class="flex h-screen overflow-hidden">
      <aside class="w-64 bg-slate-800 p-6 flex flex-col justify-between shadow-xl flex-shrink-0">
        <div>
          <div class="mb-10 text-center">
            <img src="imagens/logo-vivo.svg" alt="Logo VIVO" class="w-28 h-auto mx-auto mb-1" />
            <span class="text-2xl font-bold text-purple-400">ESSENTIAL</span>
          </div>
          <nav>
            <ul>
              <li class="mb-3">
                <a
                  href="telainicial.html"
                  id="homeLink"
                  class="sidebar-link flex items-center py-3 px-4 rounded-lg text-slate-100 transition-colors duration-200"
                >
                  <span class="mr-3">üè†</span> Home
                </a>
              </li>
              <li class="mb-3">
                <a
                  href="perfil.html"
                  id="perfilLink"
                  class="sidebar-link flex items-center py-3 px-4 rounded-lg text-slate-100 transition-colors duration-200"
                >
                  <span class="mr-3">üë§</span> Meu Perfil
                </a>
              </li>
              <li class="mb-3">
                <a
                  href="calendario.html"
                  id="calendarioLink"
                  class="sidebar-link active flex items-center py-3 px-4 rounded-lg text-slate-100 transition-colors duration-200"
                >
                  <span class="mr-3">üìÖ</span> Calend√°rio
                </a>
              </li>
              <li class="mb-3">
                <a
                  href="#"
                  id="vivinhoLink"
                  class="sidebar-link flex items-center py-3 px-4 rounded-lg text-slate-100 transition-colors duration-200"
                >
                  <span class="mr-3">üí¨</span> Q Vivinho IA
                  <span class="ml-auto text-xs text-purple-400">‚ú®</span>
                </a>
              </li>
              <li class="mb-3">
                <a
                  href="#"
                  id="cursosLink"
                  class="sidebar-link flex items-center py-3 px-4 rounded-lg text-slate-100 transition-colors duration-200"
                >
                  <span class="mr-3">üìö</span> Meus Cursos
                </a>
              </li>
              <li class="mb-3">
                <a
                  href="#"
                  id="gamificacaoLink"
                  class="sidebar-link flex items-center py-3 px-4 rounded-lg text-slate-100 transition-colors duration-200"
                >
                  <span class="mr-3">üèÜ</span> Gamifica√ß√£o Vivo
                </a>
              </li>
              <li class="mb-3">
                <a
                  href="#"
                  id="desempenhoLink"
                  class="sidebar-link flex items-center py-3 px-4 rounded-lg text-slate-100 transition-colors duration-200"
                >
                  <span class="mr-3">üìä</span> Desempenho
                </a>
              </li>
            </ul>
          </nav>
        </div>
        <div class="text-center text-xs text-slate-500">
          &copy; <span id="currentYearSidebar">2024</span> VIVO ESSENTIAL
        </div>
      </aside>

      <div class="flex-1 flex flex-col overflow-hidden">
        <header class="bg-slate-800 shadow-md p-4 flex justify-between items-center flex-shrink-0">
          <h2 class="text-xl font-semibold text-slate-200" id="pageTitle">Meu Calend√°rio</h2>
          <div class="flex items-center space-x-4">
            <button
              id="themeToggleButton"
              class="text-slate-400 hover:text-purple-400 p-2 rounded-lg focus:outline-none"
            >
              <span id="themeIcon">üåô</span>
            </button>
            <button class="text-slate-400 hover:text-purple-400">
              <svg
                xmlns="http://www.w3.org/2000/svg"
                class="h-6 w-6"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"
                />
              </svg>
            </button>
            <div class="relative">
              <button class="flex items-center text-slate-200">
                <img
                  class="h-8 w-8 rounded-full object-cover mr-2"
                  src="https://via.placeholder.com/100"
                  alt="Avatar do Usu√°rio"
                  id="userAvatarHeader"
                />
                <span id="userNameHeader">Carregando...</span>
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  class="h-5 w-5 ml-1 text-slate-400"
                  viewBox="0 0 20 20"
                  fill="currentColor"
                >
                  <path
                    fill-rule="evenodd"
                    d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z"
                    clip-rule="evenodd"
                  />
                </svg>
              </button>
            </div>
            <button
              id="logoutButtonHeader"
              class="bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-3 rounded-lg text-sm transition duration-300 ease-in-out"
            >
              Sair
            </button>
          </div>
        </header>

        <main
          class="flex-1 overflow-x-hidden overflow-y-auto bg-gradient-to-br from-slate-900 via-purple-900 to-indigo-950 p-6 md:p-8"
        >
          <div class="max-w-4xl mx-auto">
            <section id="novoEventoSection" class="form-section mb-8">
              <h2 class="text-2xl font-semibold text-purple-400 mb-6">Novo Agendamento</h2>
              <form id="formNovoEvento" class="space-y-4">
                <div>
                  <label for="eventoTitulo" class="form-label">T√≠tulo do Evento:</label>
                  <input type="text" id="eventoTitulo" name="titulo" class="form-input" required />
                </div>
                <div>
                  <label for="eventoDescricao" class="form-label">Descri√ß√£o (Opcional):</label>
                  <textarea
                    id="eventoDescricao"
                    name="descricao"
                    rows="3"
                    class="form-input"
                  ></textarea>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div>
                    <label for="eventoDataHoraInicio" class="form-label"
                      >Data e Hora de In√≠cio:</label
                    >
                    <input
                      type="datetime-local"
                      id="eventoDataHoraInicio"
                      name="dataHoraInicio"
                      class="form-input"
                      required
                    />
                  </div>
                  <div>
                    <label for="eventoDataHoraFim" class="form-label"
                      >Data e Hora de Fim (Opcional):</label
                    >
                    <input
                      type="datetime-local"
                      id="eventoDataHoraFim"
                      name="dataHoraFim"
                      class="form-input"
                    />
                  </div>
                </div>
                <div>
                  <label for="eventoTipo" class="form-label">Tipo de Evento:</label>
                  <select id="eventoTipo" name="tipoEvento" class="form-input">
                    <option value="ALINHAMENTO">Alinhamento</option>
                    <option value="REUNIAO_BUDDY">Reuni√£o com Buddy</option>
                    <option value="REUNIAO_GESTOR">Reuni√£o com Gestor</option>
                    <option value="FEEDBACK">Sess√£o de Feedback</option>
                    <option value="TREINAMENTO">Treinamento</option>
                    <option value="OUTRO" selected>Outro</option>
                  </select>
                </div>
                <div>
                  <label for="eventoLink" class="form-label">Link da Reuni√£o (Opcional):</label>
                  <input
                    type="url"
                    id="eventoLink"
                    name="linkReuniao"
                    placeholder="https://..."
                    class="form-input"
                  />
                </div>
                <div
                  id="eventoErrorMessage"
                  class="hidden text-center text-red-400 mt-2 p-2 bg-red-900 bg-opacity-30 rounded-md"
                ></div>
                <button
                  type="submit"
                  class="w-full bg-purple-600 hover:bg-purple-700 text-white font-semibold py-3 px-4 rounded-lg shadow-md transition duration-300 ease-in-out"
                >
                  Salvar Agendamento
                </button>
              </form>
            </section>

            <section id="listaEventosSection" class="form-section">
              <h2 class="text-2xl font-semibold text-purple-400 mb-6">Meus Agendamentos</h2>
              <div id="eventosContainer" class="space-y-4">
                <p id="loadingEventosMsg" class="text-slate-400">Carregando seus agendamentos...</p>
              </div>
            </section>
          </div>
        </main>
      </div>
    </div>

    <button
      title="Ajuda"
      class="fixed bottom-6 right-6 bg-purple-600 hover:bg-purple-700 text-white p-4 rounded-full shadow-lg focus:outline-none focus:ring-2 focus:ring-purple-500 focus:ring-offset-2 focus:ring-offset-slate-900 transition-transform duration-200 hover:scale-110"
    >
      <svg
        xmlns="http://www.w3.org/2000/svg"
        class="h-8 w-8"
        fill="none"
        viewBox="0 0 24 24"
        stroke="currentColor"
      >
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          stroke-width="2"
          d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.755 4 3.92C16 12.897 14.703 14 12.75 14c-.897 0-1.7-.398-2.25-.996A2.032 2.032 0 018.228 9z"
        />
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          stroke-width="2"
          d="M12 18a6 6 0 100-12 6 6 0 000 12z"
        />
      </svg>
    </button>

    <script>
      document.addEventListener('DOMContentLoaded', async function () {
        const userNameHeaderElement = document.getElementById('userNameHeader');
        const currentYearSidebarElement = document.getElementById('currentYearSidebar');
        const logoutButtonHeader = document.getElementById('logoutButtonHeader');
        const pageTitleElement = document.getElementById('pageTitle');
        const themeToggleButton = document.getElementById('themeToggleButton');
        const themeIcon = document.getElementById('themeIcon');
        const htmlElement = document.documentElement;

        // Formul√°rio Novo Evento
        const formNovoEvento = document.getElementById('formNovoEvento');
        const eventoTituloInput = document.getElementById('eventoTitulo');
        const eventoDescricaoInput = document.getElementById('eventoDescricao');
        const eventoDataHoraInicioInput = document.getElementById('eventoDataHoraInicio');
        const eventoDataHoraFimInput = document.getElementById('eventoDataHoraFim');
        const eventoTipoInput = document.getElementById('eventoTipo');
        const eventoLinkInput = document.getElementById('eventoLink');
        const eventoErrorMessageElement = document.getElementById('eventoErrorMessage');

        // Lista de Eventos
        const eventosContainer = document.getElementById('eventosContainer');
        const loadingEventosMsg = document.getElementById('loadingEventosMsg');

        // --- L√≥gica do Tema ---
        const applyTheme = (theme) => {
          if (theme === 'dark') {
            htmlElement.classList.add('dark');
            if (themeIcon) themeIcon.textContent = '‚òÄÔ∏è';
            localStorage.setItem('theme', 'dark');
          } else {
            htmlElement.classList.remove('dark');
            if (themeIcon) themeIcon.textContent = 'üåô';
            localStorage.setItem('theme', 'light');
          }
        };
        const savedTheme = localStorage.getItem('theme');
        const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
        let currentTheme = savedTheme || (prefersDark ? 'dark' : 'light');
        applyTheme(currentTheme);

        if (themeToggleButton) {
          themeToggleButton.addEventListener('click', () => {
            const newTheme = htmlElement.classList.contains('dark') ? 'light' : 'dark';
            applyTheme(newTheme);
          });
        }
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', (event) => {
          if (!localStorage.getItem('theme')) {
            applyTheme(event.matches ? 'dark' : 'light');
          }
        });
        // --- Fim L√≥gica do Tema ---

        // Marcar link ativo na sidebar e t√≠tulo da p√°gina
        const currentPage = window.location.pathname.split('/').pop();
        document
          .querySelectorAll('.sidebar-link')
          .forEach((link) => link.classList.remove('active'));
        if (currentPage === 'calendario.html') {
          document.getElementById('calendarioLink')?.classList.add('active');
          if (pageTitleElement) pageTitleElement.textContent = 'Meu Calend√°rio e Agendamentos';
        } else if (currentPage === 'perfil.html') {
          document.getElementById('perfilLink')?.classList.add('active');
          if (pageTitleElement) pageTitleElement.textContent = 'Meu Perfil';
        } else {
          // Default para Home/telainicial.html
          document.getElementById('homeLink')?.classList.add('active');
          if (pageTitleElement) pageTitleElement.textContent = 'Painel Principal';
        }

        if (currentYearSidebarElement) {
          currentYearSidebarElement.textContent = new Date().getFullYear();
        }

        const accessToken = localStorage.getItem('accessToken');

        function redirectToLogin(message) {
          alert(message + ' Redirecionando para login...');
          localStorage.removeItem('accessToken');
          localStorage.removeItem('userData');
          window.location.href = 'index.html';
        }

        if (!accessToken) {
          redirectToLogin('Acesso negado. Token n√£o encontrado.');
          return;
        }

        async function carregarDadosUsuarioHeader() {
          const userDataFromStorageString = localStorage.getItem('userData');
          if (userDataFromStorageString) {
            try {
              const userProfileData = JSON.parse(userDataFromStorageString);
              if (userNameHeaderElement)
                userNameHeaderElement.textContent = userProfileData.nomeCompleto;
            } catch (e) {
              console.error('Erro ao parsear userData do localStorage para header', e);
            }
          }
          // Opcionalmente, buscar /auth/profile se os dados do localStorage n√£o forem suficientes ou para garantir que s√£o frescos
        }

        function formatarDataParaExibicao(dataStringISO) {
          if (!dataStringISO) return 'N/A';
          const data = new Date(dataStringISO);
          return data.toLocaleString('pt-BR', {
            day: '2-digit',
            month: '2-digit',
            year: 'numeric',
            hour: '2-digit',
            minute: '2-digit',
          });
        }

        async function carregarEventos() {
          if (loadingEventosMsg) loadingEventosMsg.classList.remove('hidden');
          if (eventosContainer) eventosContainer.innerHTML = '';

          try {
            const response = await fetch('http://localhost:3000/eventos', {
              method: 'GET',
              headers: { Authorization: `Bearer ${accessToken}` },
            });

            if (response.ok) {
              const eventos = await response.json();
              if (loadingEventosMsg) loadingEventosMsg.classList.add('hidden');

              if (eventos.length === 0) {
                if (eventosContainer)
                  eventosContainer.innerHTML =
                    '<p class="text-slate-400 text-center">Voc√™ ainda n√£o tem nenhum evento agendado.</p>';
                return;
              }

              eventos.forEach((evento) => {
                const eventoCard = document.createElement('div');
                eventoCard.className = 'evento-card';
                eventoCard.innerHTML = `
                                <h3 class="font-semibold text-lg text-purple-300 mb-1">${
                                  evento.titulo
                                }</h3>
                                <p class="text-sm text-slate-300 mb-1"><strong>In√≠cio:</strong> ${formatarDataParaExibicao(
                                  evento.dataHoraInicio
                                )}</p>
                                ${
                                  evento.dataHoraFim
                                    ? `<p class="text-sm text-slate-300 mb-1"><strong>Fim:</strong> ${formatarDataParaExibicao(
                                        evento.dataHoraFim
                                      )}</p>`
                                    : ''
                                }
                                ${
                                  evento.descricao
                                    ? `<p class="text-xs text-slate-400 my-2 italic">${evento.descricao}</p>`
                                    : ''
                                }
                                <p class="text-xs text-slate-500 mt-2">Tipo: ${
                                  evento.tipoEvento
                                } | Status: <span class="font-medium">${
                  evento.statusEvento
                }</span></p>
                                ${
                                  evento.linkReuniao
                                    ? `<a href="${evento.linkReuniao}" target="_blank" rel="noopener noreferrer" class="text-xs text-purple-400 hover:text-purple-300 mt-1 inline-block underline">Link da Reuni√£o</a>`
                                    : ''
                                }
                            `;
                if (eventosContainer) eventosContainer.appendChild(eventoCard);
              });
            } else {
              const errorData = await response
                .json()
                .catch(() => ({ message: 'Erro ao carregar eventos.' }));
              if (loadingEventosMsg)
                loadingEventosMsg.textContent =
                  errorData.message || `Erro ${response.status} ao carregar eventos.`;
              console.error(
                'Falha ao buscar eventos. Status:',
                response.status,
                'Detalhes:',
                errorData
              );
            }
          } catch (e) {
            console.error('Erro de rede ao buscar eventos:', e);
            if (loadingEventosMsg)
              loadingEventosMsg.textContent = 'Erro de comunica√ß√£o ao buscar eventos.';
          }
        }

        if (formNovoEvento) {
          formNovoEvento.addEventListener('submit', async function (event) {
            event.preventDefault();
            if (eventoErrorMessageElement) {
              eventoErrorMessageElement.textContent = '';
              eventoErrorMessageElement.classList.add('hidden');
            }

            // Formatar datas para ISO string com timezone local antes de enviar
            // O input datetime-local j√° fornece a data e hora no formato que new Date() entende
            // e toISOString() converte para UTC (Z). O backend espera isso para converter para TIMESTAMP WITH LOCAL TIME ZONE.
            let dataHoraInicioISO = null;
            if (eventoDataHoraInicioInput.value) {
              // O valor de datetime-local √© YYYY-MM-DDTHH:mm
              // Precisamos garantir que seja interpretado corretamente como local antes de converter para ISO (UTC)
              const localDateInicio = new Date(eventoDataHoraInicioInput.value);
              dataHoraInicioISO = localDateInicio.toISOString();
            }

            let dataHoraFimISO = null;
            if (eventoDataHoraFimInput.value) {
              const localDateFim = new Date(eventoDataHoraFimInput.value);
              dataHoraFimISO = localDateFim.toISOString();
            }

            const eventoData = {
              titulo: eventoTituloInput.value,
              descricao: eventoDescricaoInput.value || undefined, // Envia undefined se vazio, para ser omitido
              dataHoraInicio: dataHoraInicioISO,
              dataHoraFim: dataHoraFimISO || undefined, // Envia undefined se vazio
              tipoEvento: eventoTipoInput.value,
              linkReuniao: eventoLinkInput.value || undefined, // Envia undefined se vazio
            };

            if (!eventoData.titulo || !eventoData.dataHoraInicio) {
              if (eventoErrorMessageElement) {
                eventoErrorMessageElement.textContent =
                  'T√≠tulo e Data/Hora de In√≠cio s√£o obrigat√≥rios.';
                eventoErrorMessageElement.classList.remove('hidden');
              }
              return;
            }

            console.log('Enviando novo evento:', JSON.stringify(eventoData));

            try {
              const response = await fetch('http://localhost:3000/eventos', {
                method: 'POST',
                headers: {
                  Authorization: `Bearer ${accessToken}`,
                  'Content-Type': 'application/json',
                },
                body: JSON.stringify(eventoData),
              });

              const resultData = await response.json();

              if (response.ok) {
                alert('Evento criado com sucesso!');
                formNovoEvento.reset();
                await carregarEventos();
              } else {
                console.error(
                  'Falha ao criar evento. Status:',
                  response.status,
                  'Resposta:',
                  resultData
                );
                if (eventoErrorMessageElement) {
                  let messages = 'Erro ao criar evento.';
                  if (resultData.message) {
                    messages = Array.isArray(resultData.message)
                      ? resultData.message.join('; ')
                      : resultData.message;
                  }
                  eventoErrorMessageElement.textContent = messages;
                  eventoErrorMessageElement.classList.remove('hidden');
                }
              }
            } catch (error) {
              console.error('Erro de rede ao criar evento:', error);
              if (eventoErrorMessageElement) {
                eventoErrorMessageElement.textContent = 'Erro de comunica√ß√£o com o servidor.';
                eventoErrorMessageElement.classList.remove('hidden');
              }
            }
          });
        }

        if (logoutButtonHeader) {
          logoutButtonHeader.addEventListener('click', function () {
            localStorage.removeItem('accessToken');
            localStorage.removeItem('userData');
            alert('Voc√™ saiu da plataforma.');
            window.location.href = 'index.html';
          });
        }

        await carregarDadosUsuarioHeader();
        await carregarEventos();
      });
    </script>
    <script src="js/theme-switcher.js"></script>
  </body>
</html>
