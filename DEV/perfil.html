<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <title>VIVO ESSENTIAL - Meu Perfil</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="css/style.css" />
    <style>
      body {
        font-family: 'Inter', sans-serif;
      }
      .sidebar-link.active {
        background-color: #6d28d9;
        color: white;
      }
      .sidebar-link:not(.active):hover {
        background-color: #5b21b6;
      }
      .stat-card {
        background-color: rgba(30, 41, 59, 0.7);
        border: 1px solid #4f46e5;
        border-radius: 0.75rem;
        padding: 1.5rem;
        text-align: center;
        transition: all 0.3s ease-in-out;
      }
      .stat-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 15px -3px rgba(99, 102, 241, 0.3), 0 4px 6px -4px rgba(99, 102, 241, 0.3);
      }
      .achievement-badge {
        background-color: rgba(55, 65, 81, 0.8);
        border-radius: 50%;
        width: 100px;
        height: 100px;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-direction: column;
        margin: 0.5rem;
        border: 2px solid #7c3aed;
        transition: transform 0.2s ease;
      }
      .achievement-badge:hover {
        transform: scale(1.1);
      }
      .course-card {
        background-color: rgba(45, 55, 72, 0.5);
        border-radius: 0.5rem;
        padding: 1rem;
        margin-bottom: 1rem;
        border-left: 4px solid #8b5cf6;
      }
    </style>
  </head>
  <body class="bg-slate-900 text-slate-200 selection:bg-purple-500 selection:text-white">
    <div class="flex h-screen">
      <aside class="w-64 bg-slate-800 p-6 flex flex-col justify-between shadow-xl">
        <div>
          <div class="mb-10 text-center">
            <img src="imagens/logo-vivo.svg" alt="Logo VIVO" class="w-28 h-auto mx-auto mb-1" />
            <span class="text-2xl font-bold text-purple-400">ESSENTIAL</span>
          </div>
          <nav>
            <ul>
              <li class="mb-3">
                <a
                  href="telainicial.html"
                  id="homeLink"
                  class="sidebar-link flex items-center py-3 px-4 rounded-lg text-slate-100 transition-colors duration-200"
                >
                  <span class="mr-3">üè†</span> Home
                </a>
              </li>
              <li class="mb-3">
                <a
                  href="perfil.html"
                  id="perfilLink"
                  class="sidebar-link flex items-center py-3 px-4 rounded-lg text-slate-100 transition-colors duration-200"
                >
                  <span class="mr-3">üë§</span> Meu Perfil
                </a>
              </li>
              <li class="mb-3">
                <a
                  href="#"
                  id="vivinhoLink"
                  class="sidebar-link flex items-center py-3 px-4 rounded-lg text-slate-100 transition-colors duration-200"
                >
                  <span class="mr-3">üí¨</span> Q Vivinho IA
                  <span class="ml-auto text-xs text-purple-400">‚ú®</span>
                </a>
              </li>
              <li class="mb-3">
                <a
                  href="#"
                  id="cursosLink"
                  class="sidebar-link flex items-center py-3 px-4 rounded-lg text-slate-100 transition-colors duration-200"
                >
                  <span class="mr-3">üìö</span> Meus Cursos
                </a>
              </li>
              <li class="mb-3">
                <a
                  href="#"
                  id="gamificacaoLink"
                  class="sidebar-link flex items-center py-3 px-4 rounded-lg text-slate-100 transition-colors duration-200"
                >
                  <span class="mr-3">üèÜ</span> Gamifica√ß√£o Vivo
                </a>
              </li>
              <li class="mb-3">
                <a
                  href="#"
                  id="desempenhoLink"
                  class="sidebar-link flex items-center py-3 px-4 rounded-lg text-slate-100 transition-colors duration-200"
                >
                  <span class="mr-3">üìä</span> Desempenho
                </a>
              </li>
            </ul>
          </nav>
        </div>
        <div class="text-center text-xs text-slate-500">
          &copy; <span id="currentYearSidebar">2024</span> VIVO ESSENTIAL
        </div>
      </aside>

      <div class="flex-1 flex flex-col overflow-hidden">
        <header class="bg-slate-800 shadow-md p-4 flex justify-between items-center">
          <h2 class="text-xl font-semibold text-slate-200" id="pageTitle">Meu Perfil</h2>
          <div class="flex items-center space-x-4">
            <button class="text-slate-400 hover:text-purple-400">
              <svg
                xmlns="http://www.w3.org/2000/svg"
                class="h-6 w-6"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"
                />
              </svg>
            </button>
            <div class="relative">
              <button class="flex items-center text-slate-200">
                <img
                  class="h-8 w-8 rounded-full object-cover mr-2"
                  src="https://via.placeholder.com/100"
                  alt="Avatar do Usu√°rio"
                  id="userAvatarHeader"
                />
                <span id="userNameHeader">Carregando...</span>
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  class="h-5 w-5 ml-1 text-slate-400"
                  viewBox="0 0 20 20"
                  fill="currentColor"
                >
                  <path
                    fill-rule="evenodd"
                    d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z"
                    clip-rule="evenodd"
                  />
                </svg>
              </button>
            </div>
            <button
              id="logoutButtonHeader"
              class="bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-3 rounded-lg text-sm transition duration-300 ease-in-out"
            >
              Sair
            </button>
          </div>
        </header>

        <main
          class="flex-1 overflow-x-hidden overflow-y-auto bg-gradient-to-br from-slate-900 via-purple-900 to-indigo-950 p-6 md:p-8"
        >
          <div class="max-w-5xl mx-auto">
            <div
              class="flex flex-col sm:flex-row items-center bg-slate-800 bg-opacity-60 backdrop-blur-sm rounded-xl shadow-xl p-6 md:p-8 mb-8"
            >
              <img
                id="profilePageAvatar"
                src="https://via.placeholder.com/150"
                alt="Avatar do Usu√°rio"
                class="w-32 h-32 rounded-full border-4 border-purple-500 object-cover mb-4 sm:mb-0 sm:mr-8"
              />
              <div>
                <h1 id="profilePageName" class="text-3xl font-bold text-purple-300 mb-1">
                  Carregando Nome...
                </h1>
                <p id="profilePageEmail" class="text-slate-400 mb-1">Carregando Email...</p>
                <p id="profilePageMemberSince" class="text-sm text-slate-500">
                  Membro desde: Carregando...
                </p>
                <p id="profilePageTelefone" class="text-sm text-slate-400 mt-2">
                  Telefone: Carregando...
                </p>
                <p id="profilePageDescricao" class="text-sm text-slate-400 mt-1">
                  Descri√ß√£o: Carregando...
                </p>
              </div>
              <button
                id="editProfileButton"
                class="sm:ml-auto mt-4 sm:mt-0 bg-purple-600 hover:bg-purple-700 text-white font-semibold py-2 px-4 rounded-lg"
              >
                Editar Perfil
              </button>
            </div>

            <section class="mb-8">
              <h2 class="text-2xl font-semibold text-purple-400 mb-4">Vis√£o Geral</h2>
              <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 md:gap-6">
                <div class="stat-card">
                  <div class="text-4xl font-bold text-purple-400" id="statCursosAndamento">0</div>
                  <p class="text-slate-300 mt-1">Cursos em Andamento</p>
                </div>
                <div class="stat-card">
                  <div class="text-4xl font-bold text-purple-400" id="statCursosConcluidos">0</div>
                  <p class="text-slate-300 mt-1">Cursos Conclu√≠dos</p>
                </div>
                <div class="stat-card">
                  <div class="text-4xl font-bold text-purple-400" id="statOfensiva">
                    0 <span class="text-xl">dias</span>
                  </div>
                  <p class="text-slate-300 mt-1">üî• Ofensiva</p>
                </div>
                <div class="stat-card">
                  <div class="text-4xl font-bold text-purple-400" id="statVivoCoins">0</div>
                  <p class="text-slate-300 mt-1">üí∞ Vivo Coins</p>
                </div>
              </div>
            </section>

            <section class="mb-8">
              <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-semibold text-purple-400">Medalhas e Conquistas</h2>
                <a href="#" class="text-sm text-purple-400 hover:text-purple-300"
                  >Ver Todas &rarr;</a
                >
              </div>
              <div class="flex flex-wrap justify-center sm:justify-start">
                <div class="achievement-badge">
                  <span class="text-3xl">üèÖ</span> <span class="text-xs mt-1">Pioneiro</span>
                </div>
                <div class="achievement-badge">
                  <span class="text-3xl">üåü</span> <span class="text-xs mt-1">Maratonista</span>
                </div>
                <div class="achievement-badge">
                  <span class="text-3xl">üí°</span> <span class="text-xs mt-1">Curioso</span>
                </div>
              </div>
            </section>

            <section>
              <h2 class="text-2xl font-semibold text-purple-400 mb-4">Meus Cursos</h2>
              <div class="mb-4 border-b border-slate-700">
                <nav class="-mb-px flex space-x-8" aria-label="Tabs">
                  <a
                    href="#"
                    class="border-purple-500 text-purple-400 whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm"
                    aria-current="page"
                  >
                    Em Andamento
                  </a>
                  <a
                    href="#"
                    class="border-transparent text-slate-400 hover:text-slate-200 hover:border-slate-300 whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm"
                  >
                    Conclu√≠dos
                  </a>
                </nav>
              </div>
              <div id="cursosList">
                <div class="course-card">
                  <h3 class="font-semibold text-lg text-slate-100 mb-1">
                    Introdu√ß√£o √† Cultura VIVO
                  </h3>
                  <p class="text-sm text-slate-400 mb-2">
                    Conhe√ßa os valores, a hist√≥ria e a estrutura da VIVO.
                  </p>
                  <div class="w-full bg-slate-600 rounded-full h-2.5">
                    <div class="bg-purple-500 h-2.5 rounded-full" style="width: 45%"></div>
                  </div>
                  <p class="text-xs text-slate-500 mt-1">45% conclu√≠do</p>
                </div>
              </div>
            </section>
          </div>
        </main>
      </div>
    </div>

    <button
      class="fixed bottom-6 right-6 bg-purple-600 hover:bg-purple-700 text-white p-4 rounded-full shadow-lg focus:outline-none focus:ring-2 focus:ring-purple-500 focus:ring-offset-2 focus:ring-offset-slate-900"
    >
      <svg
        xmlns="http://www.w3.org/2000/svg"
        class="h-8 w-8"
        fill="none"
        viewBox="0 0 24 24"
        stroke="currentColor"
      >
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          stroke-width="2"
          d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.755 4 3.92C16 12.897 14.703 14 12.75 14c-.897 0-1.7-.398-2.25-.996A2.032 2.032 0 018.228 9z"
        />
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          stroke-width="2"
          d="M12 18a6 6 0 100-12 6 6 0 000 12z"
        />
      </svg>
    </button>

    <script>
      document.addEventListener('DOMContentLoaded', async function () {
        const currentYearSidebarElement = document.getElementById('currentYearSidebar');
        // ... (outros getElementById como antes)
        const userNameHeaderElement = document.getElementById('userNameHeader');
        const profilePageAvatar = document.getElementById('profilePageAvatar');
        const profilePageName = document.getElementById('profilePageName');
        const profilePageEmail = document.getElementById('profilePageEmail');
        const profilePageMemberSince = document.getElementById('profilePageMemberSince');
        const profilePageTelefone = document.getElementById('profilePageTelefone');
        const profilePageDescricao = document.getElementById('profilePageDescricao');
        const statCursosAndamento = document.getElementById('statCursosAndamento');
        const statCursosConcluidos = document.getElementById('statCursosConcluidos');
        const statOfensiva = document.getElementById('statOfensiva');
        const statVivoCoins = document.getElementById('statVivoCoins');
        const logoutButtonHeader = document.getElementById('logoutButtonHeader');
        const pageTitleElement = document.getElementById('pageTitle');

        // Marcar link ativo na sidebar
        const currentPage = window.location.pathname.split('/').pop();
        if (currentPage === 'telainicial.html' || currentPage === '') {
          document.getElementById('homeLink')?.classList.add('active');
          if (pageTitleElement) pageTitleElement.textContent = 'Painel Principal';
        } else if (currentPage === 'perfil.html') {
          // Assumindo que este arquivo se chama perfil.html
          document.getElementById('perfilLink')?.classList.add('active');
          if (pageTitleElement) pageTitleElement.textContent = 'Meu Perfil';
        }

        if (currentYearSidebarElement) {
          currentYearSidebarElement.textContent = new Date().getFullYear();
        }

        const accessToken = localStorage.getItem('accessToken');

        function redirectToLogin(message) {
          alert(message + ' Redirecionando para login...');
          localStorage.removeItem('accessToken');
          localStorage.removeItem('userData');
          window.location.href = 'login.html';
        }

        // Comente este bloco para desativar o login durante o desenvolvimento
        /*
        if (!accessToken) {
        redirectToLogin('Acesso negado. Token n√£o encontrado.');
        return;
        }
        */

        // Tentamos carregar os dados do usu√°rio do localStorage primeiro para UI r√°pida
        const userDataFromStorageString = localStorage.getItem('userData');
        let userProfileData;
        if (userDataFromStorageString) {
          try {
            userProfileData = JSON.parse(userDataFromStorageString);
            if (userNameHeaderElement)
              userNameHeaderElement.textContent = userProfileData.nomeCompleto;
            if (profilePageName) profilePageName.textContent = userProfileData.nomeCompleto;
            if (profilePageEmail) profilePageEmail.textContent = userProfileData.email;
            if (profilePageTelefone)
              profilePageTelefone.textContent = `Telefone: ${
                userProfileData.telefone || 'N√£o informado'
              }`;
            if (profilePageDescricao)
              profilePageDescricao.textContent = `Descri√ß√£o: ${
                userProfileData.descricao || 'Nenhuma descri√ß√£o.'
              }`;
            if (profilePageMemberSince && userProfileData.dataCadastro) {
              profilePageMemberSince.textContent = `Membro desde: ${new Date(
                userProfileData.dataCadastro
              ).toLocaleDateString()}`;
            } else if (profilePageMemberSince) {
              profilePageMemberSince.textContent = 'Membro desde: (data n√£o dispon√≠vel)';
            }
            if (statOfensiva && userProfileData.diasOfensiva !== undefined)
              statOfensiva.innerHTML = `${userProfileData.diasOfensiva} <span class="text-xl">dias</span>`;
            if (statVivoCoins && userProfileData.vivoCoins !== undefined)
              statVivoCoins.textContent = userProfileData.vivoCoins;
          } catch (e) {
            console.error('Erro ao parsear userData do localStorage', e);
          }
        }

        try {
          const profileResponse = await fetch('http://localhost:3000/auth/profile', {
            method: 'GET',
            headers: { Authorization: `Bearer ${accessToken}` },
          });

          if (profileResponse.ok) {
            const freshUserProfileData = await profileResponse.json();
            localStorage.setItem('userData', JSON.stringify(freshUserProfileData));
            userProfileData = freshUserProfileData; // Atualiza com dados frescos

            // Re-popula ou atualiza os elementos com dados frescos
            if (userNameHeaderElement)
              userNameHeaderElement.textContent = userProfileData.nomeCompleto;
            if (profilePageName) profilePageName.textContent = userProfileData.nomeCompleto;
            if (profilePageEmail) profilePageEmail.textContent = userProfileData.email;
            if (profilePageTelefone)
              profilePageTelefone.textContent = `Telefone: ${
                userProfileData.telefone || 'N√£o informado'
              }`;
            if (profilePageDescricao)
              profilePageDescricao.textContent = `Descri√ß√£o: ${
                userProfileData.descricao || 'Nenhuma descri√ß√£o adicionada.'
              }`;

            if (profilePageMemberSince && userProfileData.dataCadastro) {
              profilePageMemberSince.textContent = `Membro desde: ${new Date(
                userProfileData.dataCadastro
              ).toLocaleDateString()}`;
            } else if (profilePageMemberSince) {
              profilePageMemberSince.textContent = 'Membro desde: (data n√£o dispon√≠vel)';
            }
            if (statOfensiva)
              statOfensiva.innerHTML = `${
                userProfileData.diasOfensiva || 0
              } <span class="text-xl">dias</span>`;
            if (statVivoCoins) statVivoCoins.textContent = userProfileData.vivoCoins || 0;

            // TODO: Popular estat√≠sticas de cursos, medalhas com dados reais do backend
            if (statCursosAndamento) statCursosAndamento.textContent = '0'; // Placeholder
            if (statCursosConcluidos) statCursosConcluidos.textContent = '0'; // Placeholder
          } else {
            if (!userProfileData) {
              // S√≥ redireciona se n√£o conseguiu carregar nem do localStorage
              const errorData = await profileResponse
                .json()
                .catch(() => ({ message: 'Sess√£o inv√°lida.' }));
              redirectToLogin(
                errorData.message || `Erro ${profileResponse.status}: Sess√£o inv√°lida.`
              );
            } else {
              // Se tinha dados do localStorage, talvez apenas mostre um erro discreto ou tente um refresh token no futuro
              console.error(
                'Falha ao buscar perfil fresco do backend. Status:',
                profileResponse.status
              );
            }
          }
        } catch (e) {
          if (!userProfileData) {
            redirectToLogin('Erro de comunica√ß√£o ao buscar perfil.');
          } else {
            console.error('Erro de rede ao buscar perfil fresco:', e);
          }
        }

        if (logoutButtonHeader) {
          // ... (c√≥digo do logoutButtonHeader como antes) ...
          logoutButtonHeader.addEventListener('click', function () {
            localStorage.removeItem('accessToken');
            localStorage.removeItem('userData');
            alert('Voc√™ saiu da plataforma.');
            window.location.href = 'index.html';
          });
        }
        // L√≥gica para o bot√£o Editar Perfil (a ser implementada)
        const editProfileButton = document.getElementById('editProfileButton');
        if (editProfileButton) {
          editProfileButton.addEventListener('click', function () {
            alert('Funcionalidade "Editar Perfil" a ser implementada!');
            // Aqui voc√™ pode, por exemplo, transformar os campos de texto em inputs edit√°veis
            // ou redirecionar para uma p√°gina/modal de edi√ß√£o.
          });
        }
      });
    </script>
    <script src="js/theme-switcher.js"></script>
  </body>
</html>
